<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>KnowHub Â· ç§‘æ°åŠ› 3D æ¨¡æ“¬å™¨</title>

  <!-- KnowHub å…±ç”¨æ¨£å¼ -->
  <link rel="stylesheet" href="assets/css/template.css" />
  <link rel="stylesheet" href="assets/css/knowledge.css" />

  <!-- Page-local tweaks: ä¸æ”¹å‹•æ ¸å¿ƒ JSï¼Œåªè™•ç†ç‰ˆé¢èˆ‡å®¹å™¨å°ºå¯¸ -->
  <style>
    :root{
      --sim-controls-w: 320px;
    }
    /* è®“æ•´é ç”¨å½ˆæ€§æ’ç‰ˆï¼ŒHeader / Main / Footer */
    body.kh-body{
      min-height: 100vh;
      display: grid;
      grid-template-rows: auto 1fr auto;
      background: #0b1220;
      color: #e7ecf3;
      overflow: hidden; /* èˆ‡åŸæœ¬æ»¿ç‰ˆ 3D ä¸€è‡´ */
    }

    /* ä¸»å€åŸŸå®¹å™¨ */
    .kh-main{
      position: relative;
      display: grid;
      grid-template-columns: 1fr;
      align-items: stretch;
    }

    /* æ‰¿æ¥åŸæœ¬ #container å…¨è¦–çª—ç•«å¸ƒï¼Œä½†é¿é–‹ header / footer */
    .sim-stage{
      position: relative;
      width: 100%;
      height: 100%;
      overflow: hidden;
    }
    /* æŠŠåŸæœ¬ k.html çš„ #container å¡åœ¨é€™è£¡è·‘æ»¿ */
    #container{
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
    }

    /* åŸæª”çš„ loader / info / controls ä¾èˆŠçµ•å°å®šä½ï¼Œä½†å¾®èª¿ä»¥é…åˆ KnowHub */
    #loader{
      z-index: 50;
      text-shadow: 0 0 10px #00aaff;
    }
    #info{
      position: absolute;
      bottom: 16px;
      width: 100%;
      text-align: center;
      color: #9db4c9;
      font-size: 12px;
      z-index: 40;
      pointer-events: none;
    }
    /* æ§åˆ¶é¢æ¿ç¶­æŒåŸå¯¬ï¼Œå³ä¸Šè§’ä¸è·Ÿ header æ‰“æ¶ */
    #controls{
      position: absolute;
      top: 88px;          /* header é«˜åº¦ä¿ç•™ç©ºé–“ */
      left: 20px;
      z-index: 60;
      width: var(--sim-controls-w);
      background: rgba(10, 20, 35, 0.85);
      padding: 20px 16px 16px;
      border-radius: 12px;
      border: 1px solid rgba(0, 170, 255, 0.4);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      font-family: 'Orbitron', sans-serif;
      box-shadow: 0 0 25px rgba(0, 170, 255, 0.2);
      display: none; /* init éšæ®µå…ˆéš±è—ï¼Œè¼‰å…¥å¾Œé¡¯ç¤ºï¼ˆèˆ‡åŸæœ¬ä¸€è‡´ï¼‰ */
      transform: translateX(0);
      transition: transform 200ms ease, opacity 200ms ease;
    }
    #controls.collapsed{
      transform: translateX(calc(-100% - 24px));
      opacity: .9;
    }

    /* æ§åˆ¶é¢æ¿æ¨™é¡Œåˆ— + æ‘ºç–ŠæŒ‰éˆ• */
    .controls-header{
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin: -6px -4px 10px;
      padding-bottom: 8px;
      border-bottom: 1px dashed rgba(0, 170, 255, 0.35);
    }
    .controls-title{
      font-size: 14px;
      letter-spacing: .5px;
      color: #a9e6ff;
    }
    .controls-toggle{
      font-family: 'Noto Sans TC', sans-serif;
      font-size: 12px;
      line-height: 1;
      padding: 6px 10px;
      border-radius: 8px;
      border: 1px solid rgba(0, 170, 255, 0.6);
      background: rgba(0, 170, 255, 0.15);
      color: #e7faff;
      cursor: pointer;
    }

    /* æ”¶åˆæ™‚åœ¨ç•«é¢é‚Šç·£é¡¯ç¤ºä¸€å€‹ã€Œå±•é–‹ã€å°éˆ• */
    #controls-peek{
      position: absolute;
      top: 88px;
      left: 12px;
      z-index: 61;
      display: none; /* é è¨­é—œé–‰ï¼Œç•¶ #controls è¢«æ”¶åˆæ™‚é¡¯ç¤º */
    }
    #controls-peek.show{
      display: block;
    }
    #controls-peek .btn{
      padding: 8px 10px;
      border-radius: 999px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.35);
      font-size: 13px;
    }

    .control-row { display: flex; align-items: center; margin-bottom: 14px; }
    .control-row label { margin-right: 15px; font-size: 14px; min-width: 100px; color: #00aaff; }
    input[type="range"] { width: 100%; -webkit-appearance: none; background: transparent; }
    input[type="range"]::-webkit-slider-runnable-track { height: 4px; background: rgba(0, 170, 255, 0.3); border-radius: 2px; }
    input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; height: 16px; width: 16px; background: #00aaff; border-radius: 50%; border: 2px solid #111; margin-top: -6px; box-shadow: 0 0 10px #00aaff; }
    .value-display { font-weight: bold; color: #00e0ff; min-width: 50px; text-align: left; }
    .divider { height: 1px; background-image: linear-gradient(to right, rgba(0,170,255,0), rgba(0,170,255,0.5), rgba(0,170,255,0)); border: 0; margin: 18px 0; }
    .radio-group label { display: flex; align-items: center; font-size: 13px; margin-right: 15px; cursor: pointer; color: #eee; }
    .wind-controls { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    .wind-controls button { font-family: 'Noto Sans TC', sans-serif; background-color: rgba(0, 170, 255, 0.2); border: 1px solid rgba(0, 170, 255, 0.5); color: #fff; padding: 6px 10px; border-radius: 5px; cursor: pointer; font-size: 12px; transition: all 0.2s; }
    .wind-controls button.active { background-color: #007bff; border-color: #00aaff; box-shadow: 0 0 8px #007bff; }
    #tooltip { position: absolute; background: rgba(0,0,0,0.8); border: 1px solid #00aaff; padding: 10px; border-radius: 5px; color: #fff; font-family: 'Noto Sans TC', sans-serif; font-size: 13px; max-width: 250px; z-index: 200; pointer-events: none; opacity: 0; transition: opacity 0.2s; }

    /* æµ®å‹•å›é¦–é æŒ‰éˆ•ï¼ˆèˆ‡ knowledge çš„ kh-bottom-home å‘¼æ‡‰ï¼Œä½†åšæˆ FABï¼‰ */
    .kh-home-fab{
      position: absolute;
      right: 20px;
      bottom: 20px;
      z-index: 70;
    }
    .kh-home-fab .btn{
      padding: 10px 14px;
      border-radius: 999px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.35);
    }

    /* æ‰‹æ©Ÿå„ªåŒ–ï¼šæ§åˆ¶é¢æ¿å¾€ä¸‹è®“å‡ºæ›´å¤šè¦–çª—é«˜åº¦ */
    @media (max-width: 768px){
      #controls{
        top: 100px;
        left: 12px;
        width: min(88vw, var(--sim-controls-w));
      }
      #controls-peek{
        top: 100px;
        left: 8px;
      }
    }
  </style>

  <!-- Google Fonts èˆ‡åŸæ¨£å¼ï¼ˆä¿ç•™åŸå­—å‹è¨­å®šä»¥é¿å…è¦–è¦ºçªå…€ï¼‰ -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
</head>
<body class="kh-body">
  <!-- Headerï¼ˆèˆ‡ knowledge/vocab/toeic åŒé¢¨æ ¼ï¼ŒLogo å¯å›é¦–é ï¼‰ -->
  <header class="kh-header">
    <div class="kh-header__inner">
      <a class="kh-logo" href="./index.html" aria-label="å›åˆ°é¦–é ">
        <img src="./images/Know-hub.png" alt="KnowHub Logo" />
      </a>
    </div>
  </header>

  <!-- Mainï¼šå…¨è¢å¹• 3D å ´æ™¯ -->
  <main class="kh-main">
    <section class="sim-stage" aria-label="ç§‘æ°åŠ› 3D æ¨¡æ“¬å™¨">
      <div id="loader">ULTIMATE EARTH SIMULATOR /// LOADING...</div>
      <div id="container" aria-label="WebGL å ´æ™¯å®¹å™¨"></div>
      <div id="tooltip" role="tooltip"></div>

      <!-- åŸæª”æ§åˆ¶é¢æ¿ï¼ˆä¿ç•™ ID / çµæ§‹ / äº‹ä»¶ï¼‰ï¼ŒåŠ ä¸Šå¯æ‘ºç–ŠåŠŸèƒ½ -->
      <div id="controls" aria-label="æ§åˆ¶é¢æ¿" aria-expanded="true">
        <div class="controls-header">
          <div class="controls-title">âš™ï¸ æ§åˆ¶é¢æ¿</div>
          <button id="controlsToggle" class="controls-toggle" type="button" aria-controls="controls" aria-expanded="true">â®œ æ”¶èµ·</button>
        </div>

        <div class="control-row" data-tooltip="èª¿æ•´åœ°çƒè‡ªè½‰çš„è§’é€Ÿåº¦ã€‚æ­£å€¼ç‚ºé †æ™‚é‡ï¼ˆè¥¿å‘æ±ï¼‰ï¼Œè² å€¼ç‚ºé€†æ™‚é‡ã€‚é€Ÿåº¦å¤§å°ç›´æ¥å½±éŸ¿ç§‘æ°åŠ›å¼·åº¦ã€‚">
          <label>è‡ªè½‰é€Ÿåº¦:</label>
          <input type="range" id="rotationSpeed" min="-100" max="100" value="15">
        </div>
        <div class="control-row" data-tooltip="ç§‘æ°åŠ›çš„ç›¸å°å¼·åº¦ï¼Œç”±è‡ªè½‰é€Ÿåº¦è‡ªå‹•è¨ˆç®—å¾—å‡ºã€‚">
          <label>ç§‘æ°åŠ›:</label>
          <span id="coriolisValue" class="value-display"></span>
        </div>
        <hr class="divider">
        <div class="control-row" data-tooltip="åˆ‡æ›è§€å¯Ÿè€…çš„åƒè€ƒç³»ã€‚å¤ªç©ºè¦–è§’ï¼šæ‚¨éœæ­¢ï¼Œåœ°çƒç³»çµ±è½‰å‹•ã€‚åœ°çƒè¦–è§’ï¼šæ‚¨éš¨åœ°çƒè½‰å‹•ï¼Œé¢¨åœ¨éœæ­¢çš„åœ°çƒä¸Šæµå‹•ã€‚">
          <label>è§€å¯Ÿè¦–è§’:</label>
          <div class="radio-group">
            <label><input type="radio" name="viewMode" value="space" checked> å¤ªç©º</label>
            <label><input type="radio" name="viewMode" value="earth"> åœ°çƒ</label>
          </div>
        </div>
        <div class="control-row" data-tooltip="é¸æ“‡é¡¯ç¤ºçš„å‘é‡ã€‚é¢¨å‘ï¼ˆç¶ è‰²ï¼‰æ˜¯ç©ºæ°£å¯¦éš›é‹å‹•è·¯å¾‘ã€‚ç§‘æ°åŠ›ï¼ˆç´…è‰²ï¼‰æ˜¯å°è‡´é¢¨å‘åè½‰çš„è™›æ“¬åŠ›ã€‚">
          <label>é¡¯ç¤ºå‘é‡:</label>
          <div class="radio-group">
            <label><input type="radio" name="vectorMode" value="wind" checked> é¢¨å‘</label>
            <label><input type="radio" name="vectorMode" value="coriolis"> ç§‘æ°åŠ›</label>
            <label><input type="radio" name="vectorMode" value="both"> å…©è€…</label>
          </div>
        </div>
        <hr class="divider">
        <div class="wind-controls">
          <button id="btn-n2e" class="active" data-tooltip="é¡¯ç¤ºå¾åŒ—åŠçƒé«˜å£“å€ï¼ˆæ¥µåœ°ï¼‰å¹å‘èµ¤é“çš„é¢¨ã€‚">åŒ—æ¥µ > èµ¤é“</button>
          <button id="btn-e2n" class="active" data-tooltip="é¡¯ç¤ºå¾èµ¤é“ä½å£“å€å¹å‘åŒ—åŠçƒçš„é¢¨ã€‚">èµ¤é“ > åŒ—æ¥µ</button>
          <button id="btn-s2e" class="active" data-tooltip="é¡¯ç¤ºå¾å—åŠçƒé«˜å£“å€ï¼ˆæ¥µåœ°ï¼‰å¹å‘èµ¤é“çš„é¢¨ã€‚">å—æ¥µ > èµ¤é“</button>
          <button id="btn-e2s" class="active" data-tooltip="é¡¯ç¤ºå¾èµ¤é“ä½å£“å€å¹å‘å—åŠçƒçš„é¢¨ã€‚">èµ¤é“ > å—æ¥µ</button>
        </div>
      </div>

      <!-- æ”¶åˆå¾Œçš„ã€Œå±•é–‹æ§åˆ¶é¢æ¿ã€å°éˆ• -->
      <div id="controls-peek" class="kh-home-fab">
        <button id="controlsShow" class="btn btn-primary" type="button" aria-controls="controls" aria-expanded="false">ğŸ› ï¸ å±•é–‹æ§åˆ¶é¢æ¿</button>
      </div>

      <div id="info">æ»‘é¼ å·¦éµæ‹–æ›³æ—‹è½‰ï¼Œæ»¾è¼ªç¸®æ”¾ï¼Œå³éµå¹³ç§»ã€‚</div>

      <!-- å›é¦–é  FAB -->
      <div class="kh-home-fab" style="right: 20px; bottom: 20px;">
        <a class="btn btn-primary" href="./index.html" aria-label="å›åˆ°é¦–é ">ğŸ  å›é¦–é </a>
      </div>
    </section>
  </main>

  <!-- Footer -->
  <footer class="kh-footer">
    <div class="kh-footer__inner">
      <small>Â© <span id="year"></span> KnowHub â€” Keep learning, keep earning ğŸ’¸</small>
    </div>
  </footer>

  <script>
    // Footer å¹´ä»½
    document.getElementById('year').textContent = new Date().getFullYear();
  </script>

  <!-- three.js èˆ‡åŸæœ¬ä¾è³´ï¼ˆä¿æŒç‰ˆæœ¬èˆ‡é †åºï¼‰ -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>

  <!-- åŸ k.html è…³æœ¬ï¼ˆæœªæ”¹å‹•æ¼”ç®—æ³•èˆ‡çµæ§‹ï¼‰ -->
  <script>
    // --- Shaders ---
    const earthVS = `varying vec2 vUv; varying vec3 vNormal; varying vec3 vPosition; void main() { vUv = uv; vPosition = position; vNormal = normalize(normalMatrix * normal); gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0); }`;
    const earthFS = `uniform sampler2D tD; uniform sampler2D tN; uniform sampler2D tS; varying vec2 vUv; varying vec3 vNormal; varying vec3 vPosition; uniform vec3 sunDir; void main() { vec3 day = texture2D(tD, vUv).rgb; vec3 night = texture2D(tN, vUv).rgb; float intensity = max(dot(vNormal, normalize(sunDir)), 0.0); float specStr = texture2D(tS, vUv).r; vec3 viewDir = normalize(-vPosition); vec3 reflectDir = reflect(-sunDir, vNormal); float spec = pow(max(dot(viewDir, reflectDir), 0.0), 16.0) * specStr; float mixVal = smoothstep(-0.1, 0.2, intensity); vec3 final = mix(night*1.5, day, mixVal); final += vec3(1.0, 0.9, 0.7) * spec * 1.5 * mixVal; gl_FragColor = vec4(final, 1.0); }`;
    const atmosphereVS = `varying vec3 vN; void main() { vN = normalize(normalMatrix * normal); gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0); }`;
    const atmosphereFS = `varying vec3 vN; void main() { float i = pow(0.5 - dot(vN, vec3(0,0,1.0)), 2.0); gl_FragColor = vec4(0.3, 0.6, 1.0, 1.0) * i; }`;

    // --- Core Variables ---
    let scene, camera, renderer, controls, clock, sunLight, starField;
    let earth, clouds, atmosphere, windSystem;
    const windData = []; const arrowCount = 250; const earthRadius = 5;
    let viewMode = 'space', vectorMode = 'wind';
    const windToggles = { n2e: true, e2n: true, s2e: true, e2s: true };

    init();

    function init() {
      scene = new THREE.Scene();
      camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
      camera.position.set(-5, 5, 15);
      clock = new THREE.Clock();
      renderer = new THREE.WebGLRenderer({ antialias: true });
      renderer.setSize(window.innerWidth, window.innerHeight);
      renderer.setPixelRatio(window.devicePixelRatio);
      document.getElementById('container').appendChild(renderer.domElement);
      controls = new THREE.OrbitControls(camera, renderer.domElement);
      controls.enableDamping = true; controls.minDistance = 6.5; controls.maxDistance = 50;
      scene.add(new THREE.AmbientLight(0x101010));
      sunLight = new THREE.DirectionalLight(0xffffff, 1.5);
      sunLight.position.set(100, 10, 50);
      scene.add(sunLight);

      const manager = new THREE.LoadingManager();
      manager.onLoad = () => {
        document.getElementById('loader').style.display = 'none';
        const panel = document.getElementById('controls');
        const peek = document.getElementById('controls-peek');
        panel.style.display = 'block'; // èˆ‡èˆŠè¡Œç‚ºä¸€è‡´ï¼šè¼‰å…¥å®Œæˆæ‰é¡¯ç¤º
        setupControls();
        bindCollapse(panel, peek);
        introAnimation();
        animate();
      };
      const texLoader = new THREE.TextureLoader(manager);

      starField = new THREE.Mesh(new THREE.SphereGeometry(200, 64, 64), new THREE.MeshBasicMaterial({ map: texLoader.load('https://raw.githubusercontent.com/mrdoob/three.js/master/examples/textures/starry-night.jpg'), side: THREE.BackSide }));
      scene.add(starField);

      const earthGeo = new THREE.SphereGeometry(earthRadius, 64, 64);
      earth = new THREE.Mesh(earthGeo, new THREE.ShaderMaterial({ vertexShader: earthVS, fragmentShader: earthFS, uniforms: { tD: { value: texLoader.load('https://threejs.org/examples/textures/land_ocean_ice_cloud_2048.jpg') }, tN: { value: texLoader.load('https://threejs.org/examples/textures/earth_lights_2048.png') }, tS: { value: texLoader.load('https://threejs.org/examples/textures/water_2048.png') }, sunDir: { value: sunLight.position } } }));
      scene.add(earth);
      atmosphere = new THREE.Mesh(earthGeo, new THREE.ShaderMaterial({ vertexShader: atmosphereVS, fragmentShader: atmosphereFS, blending: THREE.AdditiveBlending, side: THREE.BackSide }));
      atmosphere.scale.set(1.1, 1.1, 1.1);
      scene.add(atmosphere);
      clouds = new THREE.Mesh(new THREE.SphereGeometry(earthRadius + 0.05, 64, 64), new THREE.MeshPhongMaterial({ map: texLoader.load('https://threejs.org/examples/textures/earth_clouds_2048.png'), transparent: true, opacity: 0.6, blending: THREE.AdditiveBlending }));
      scene.add(clouds);

      windSystem = new THREE.Group();
      scene.add(windSystem);
      for (let i = 0; i < arrowCount; i++) {
        const lat = Math.random() * 180 - 90; const lon = Math.random() * 360 - 180;
        let dir; if (lat > 0) dir = (Math.random() > 0.5) ? 'e2n' : 'n2e'; else dir = (Math.random() > 0.5) ? 'e2s' : 's2e';
        const windArrow = new THREE.ArrowHelper(new THREE.Vector3(0, 1, 0), new THREE.Vector3(), 0.5, 0x00ff00, 0.25, 0.2);
        const coriolisArrow = new THREE.ArrowHelper(new THREE.Vector3(0, 1, 0), new THREE.Vector3(), 0.4, 0xff0000, 0.2, 0.15);
        windSystem.add(windArrow); windSystem.add(coriolisArrow);
        windData.push({ lat, lon, dir, speed: (Math.random() * 0.1 + 0.05) * 0.5, windArrow, coriolisArrow });
      }
      window.addEventListener('resize', onWindowResize, false);
    }

    function setupControls() {
      const rotSlider = document.getElementById('rotationSpeed');
      const coriolisDisplay = document.getElementById('coriolisValue');
      rotSlider.addEventListener('input', () => { coriolisDisplay.textContent = (Math.abs(rotSlider.value) * 50).toFixed(0); });
      coriolisDisplay.textContent = (Math.abs(rotSlider.value) * 50).toFixed(0);
      document.querySelectorAll('input[name="viewMode"]').forEach(r => r.addEventListener('change', e => viewMode = e.target.value));
      document.querySelectorAll('input[name="vectorMode"]').forEach(r => r.addEventListener('change', e => vectorMode = e.target.value));
      Object.keys(windToggles).forEach(key => {
        const btn = document.getElementById(`btn-${key}`);
        btn.addEventListener('click', () => { windToggles[key] = !windToggles[key]; btn.classList.toggle('active'); });
      });
      const tooltip = document.getElementById('tooltip');
      document.querySelectorAll('[data-tooltip]').forEach(el => {
        el.addEventListener('mouseenter', () => { tooltip.textContent = el.dataset.tooltip; tooltip.style.opacity = 1; });
        el.addEventListener('mouseleave', () => { tooltip.style.opacity = 0; });
        el.addEventListener('mousemove', e => { tooltip.style.left = `${e.clientX + 15}px`; tooltip.style.top = `${e.clientY + 15}px`; });
      });
    }

    // ç¶å®šæ‘ºç–Š/å±•é–‹é‚è¼¯ï¼ˆä¸ç¢°æ—¢æœ‰æ§åˆ¶å™¨èˆ‡å‹•ç•«é‚è¼¯ï¼‰
    function bindCollapse(panel, peek){
      const toggleBtn = document.getElementById('controlsToggle');
      const showBtn = document.getElementById('controlsShow');

      const setExpanded = (expanded) => {
        panel.classList.toggle('collapsed', !expanded);
        panel.setAttribute('aria-expanded', String(expanded));
        toggleBtn.setAttribute('aria-expanded', String(expanded));
        toggleBtn.textContent = expanded ? 'â®œ æ”¶èµ·' : 'â® å±•é–‹';
        peek.classList.toggle('show', !expanded);
        showBtn.setAttribute('aria-expanded', String(!expanded));
      };

      // é è¨­å±•é–‹
      setExpanded(true);

      toggleBtn.addEventListener('click', () => {
        const expanded = panel.getAttribute('aria-expanded') === 'true';
        setExpanded(!expanded);
      });
      showBtn.addEventListener('click', () => setExpanded(true));
    }

    function introAnimation() {
      const startPos = camera.position.clone();
      const endPos = new THREE.Vector3(0, 0, 12);
      let t = 0;
      function animateIntro() {
        if (t > 1) return;
        requestAnimationFrame(animateIntro);
        t += 0.005;
        camera.position.lerpVectors(startPos, endPos, t);
        controls.update();
      }
      animateIntro();
    }

    function latLonToVector3(lat, lon, r) { const p = (90 - lat) * Math.PI / 180; const t = (lon + 180) * Math.PI / 180; return new THREE.Vector3(-r * Math.sin(p) * Math.cos(t), r * Math.cos(p), r * Math.sin(p) * Math.sin(t)); }
    function onWindowResize() {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    }

    function animate() {
      requestAnimationFrame(animate);
      const dt = clock.getDelta();
      const rotSpeed = document.getElementById('rotationSpeed').value / 1000;

      // View Mode
      if (viewMode === 'space') {
        earth.rotation.y += rotSpeed * dt;
        clouds.rotation.y += rotSpeed * 1.2 * dt;
        windSystem.rotation.y = earth.rotation.y;
        starField.rotation.y = 0;
      } else {
        earth.rotation.y = 0; clouds.rotation.y = 0; windSystem.rotation.y = 0;
        starField.rotation.y -= rotSpeed * dt;
      }

      // Wind + Coriolis
      for (const data of windData) {
        const isVisible = windToggles[data.dir];
        data.windArrow.visible = isVisible && (vectorMode === 'wind' || vectorMode === 'both');
        data.coriolisArrow.visible = isVisible && (vectorMode === 'coriolis' || vectorMode === 'both');
        if (!isVisible) continue;

        const currentPos = latLonToVector3(data.lat, data.lon, 5.2);
        if (data.dir === 'e2n') { data.lat += data.speed; if (data.lat > 89) data.lat = 1; }
        else if (data.dir === 'e2s') { data.lat -= data.speed; if (data.lat < -89) data.lat = -1; }
        else if (data.dir === 'n2e') { data.lat -= data.speed; if (data.lat < 1) data.lat = 89; }
        else if (data.dir === 's2e') { data.lat += data.speed; if (data.lat > -1) data.lat = -89; }

        const coriolisEffect = rotSpeed * 2500 * Math.sin(data.lat * Math.PI / 180) * dt;
        if (data.dir === 'e2n' || data.dir === 's2e') { data.lon -= coriolisEffect; } else { data.lon += coriolisEffect; }

        const nextPos = latLonToVector3(data.lat, data.lon, 5.2);
        const windVec = nextPos.clone().sub(currentPos).normalize();

        data.windArrow.position.copy(nextPos);
        if (windVec.lengthSq() > 0.0001) data.windArrow.setDirection(windVec);

        if (data.coriolisArrow.visible) {
          const omega = new THREE.Vector3(0, rotSpeed * 50, 0);
          const coriolisVec = new THREE.Vector3().crossVectors(windVec, omega);
          data.coriolisArrow.position.copy(nextPos);
          if (coriolisVec.lengthSq() > 0.0001) data.coriolisArrow.setDirection(coriolisVec.normalize());
        }
      }

      controls.update();
      renderer.render(scene, camera);
    }
  </script>
</body>
</html>
